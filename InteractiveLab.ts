// InteractiveLab.ts
// Interactive console interface for cell division simulation

import * as readline from "readline-sync";
import { Cell } from "./Cell";
import { BloodCell, BrainCell } from "./SpecializedCells";
import { CellFactory } from "./CellFactory";

export class InteractiveLab {
  private cells: Cell[];
  private factory: CellFactory;
  private running: boolean;

  constructor() {
    this.cells = [];
    this.factory = new CellFactory();
    this.running = true;
  }

  // Main menu loop
  start(): void {
    console.log("üß¨ Welcome to the Interactive Cell Division Lab!");
    console.log("=====================================");
    console.log("Experience the Prototype Design Pattern in action!\n");

    while (this.running) {
      this.showMenu();
      const choice = readline.question("\nEnter your choice (1-8): ");
      this.handleChoice(choice);

      if (this.running) {
        readline.question("\nPress Enter to continue...");
        console.clear();
      }
    }
  }

  private showMenu(): void {
    console.log("\nüìã CELL LAB MENU");
    console.log("================");
    console.log("1. üî¨ Create Cell from Prototype");
    console.log("2. üå± Make Cell Divide");
    console.log("3. üí™ Help Cell Grow");
    console.log("4. üìä View All Cells");
    console.log("5. üß† Teach Brain Cell");
    console.log("6. ü©∏ Give Oxygen to Blood Cell");
    console.log("7. üè≠ Manage Prototypes");
    console.log("8. üö™ Exit Lab");

    if (this.cells.length > 0) {
      console.log(`\nüìà Current cells in lab: ${this.cells.length}`);
    }
  }

  private handleChoice(choice: string): void {
    switch (choice.trim()) {
      case "1":
        this.createCellFromPrototype();
        break;
      case "2":
        this.divideCellInteractive();
        break;
      case "3":
        this.growCellInteractive();
        break;
      case "4":
        this.viewAllCells();
        break;
      case "5":
        this.teachBrainCell();
        break;
      case "6":
        this.giveOxygenToBloodCell();
        break;
      case "7":
        this.managePrototypes();
        break;
      case "8":
        this.exitLab();
        break;
      default:
        console.log("‚ùå Invalid choice! Please enter 1-8.");
    }
  }

  private createCellFromPrototype(): void {
    console.log("\nüî¨ CREATE NEW CELL");
    console.log("==================");

    const prototypes = this.factory.listPrototypes();
    console.log("Available cell prototypes:");
    prototypes.forEach((type, index) => {
      console.log(`${index + 1}. ${type}`);
    });

    const choice = readline.question(
      `\nChoose prototype (1-${prototypes.length}): `
    );
    const index = parseInt(choice) - 1;

    if (index >= 0 && index < prototypes.length) {
      const cellType = prototypes[index];
      try {
        const newCell = this.factory.getCellCopy(cellType);
        this.cells.push(newCell);
        console.log(`\n‚úÖ Successfully created ${cellType} cell!`);
        console.log(`üìã ${newCell.getInfo()}`);
      } catch (error) {
        console.log(`‚ùå Failed to create cell: ${error}`);
      }
    } else {
      console.log("‚ùå Invalid choice!");
    }
  }

  private divideCellInteractive(): void {
    console.log("\nüå± CELL DIVISION");
    console.log("================");

    if (this.cells.length === 0) {
      console.log("‚ùå No cells in the lab! Create some cells first.");
      return;
    }

    this.showCellList();
    const choice = readline.question(
      `\nChoose cell to divide (1-${this.cells.length}): `
    );
    const index = parseInt(choice) - 1;

    if (index >= 0 && index < this.cells.length) {
      const cell = this.cells[index];
      console.log(`\nüîç Selected: ${cell.getInfo()}`);

      if (cell.energy < 50) {
        console.log("‚ö†Ô∏è  Cell doesn't have enough energy to divide!");
        const grow = readline.question(
          "Would you like to help it grow first? (y/n): "
        );
        if (grow.toLowerCase() === "y") {
          cell.grow();
          cell.grow();
          console.log("üí™ Cell has grown stronger!");
        }
      }

      try {
        const newCell = cell.divide();
        this.cells.push(newCell);
        console.log("\nüéâ Division successful!");
        console.log(`üë∂ New cell: ${newCell.getInfo()}`);
        console.log(`üë¥ Parent cell: ${cell.getInfo()}`);
      } catch (error) {
        console.log(`‚ùå Division failed: ${error}`);
      }
    } else {
      console.log("‚ùå Invalid cell number!");
    }
  }

  private growCellInteractive(): void {
    console.log("\nüí™ HELP CELL GROW");
    console.log("==================");

    if (this.cells.length === 0) {
      console.log("‚ùå No cells in the lab! Create some cells first.");
      return;
    }

    this.showCellList();
    const choice = readline.question(
      `\nChoose cell to help grow (1-${this.cells.length}): `
    );
    const index = parseInt(choice) - 1;

    if (index >= 0 && index < this.cells.length) {
      const cell = this.cells[index];
      console.log(`\nüîç Before: ${cell.getInfo()}`);

      cell.grow();
      console.log(`‚úÖ After:  ${cell.getInfo()}`);
      console.log("üå± Cell has grown stronger and older!");
    } else {
      console.log("‚ùå Invalid cell number!");
    }
  }

  private viewAllCells(): void {
    console.log("\nüìä ALL CELLS IN LAB");
    console.log("===================");

    if (this.cells.length === 0) {
      console.log("üî¨ Lab is empty! No cells found.");
      return;
    }

    console.log(`Total cells: ${this.cells.length}\n`);

    const basicCells = this.cells.filter(
      (c) => !(c instanceof BloodCell) && !(c instanceof BrainCell)
    );
    const bloodCells = this.cells.filter((c) => c instanceof BloodCell);
    const brainCells = this.cells.filter((c) => c instanceof BrainCell);

    if (basicCells.length > 0) {
      console.log("üîπ Basic Cells:");
      basicCells.forEach((cell, i) =>
        console.log(`   ${i + 1}. ${cell.getInfo()}`)
      );
    }

    if (bloodCells.length > 0) {
      console.log("\nü©∏ Blood Cells:");
      bloodCells.forEach((cell, i) => {
        const bloodCell = cell as BloodCell;
        console.log(
          `   ${i + 1}. ${cell.getInfo()} | O2: ${bloodCell.oxygenLevel}`
        );
      });
    }

    if (brainCells.length > 0) {
      console.log("\nüß† Brain Cells:");
      brainCells.forEach((cell, i) => {
        const brainCell = cell as BrainCell;
        console.log(`   ${i + 1}. ${cell.getInfo()}`);
        console.log(`      Knowledge: ${brainCell.getKnowledge().join(", ")}`);
      });
    }
  }

  private teachBrainCell(): void {
    console.log("\nüß† TEACH BRAIN CELL");
    console.log("===================");

    const brainCells = this.cells.filter(
      (c) => c instanceof BrainCell
    ) as BrainCell[];

    if (brainCells.length === 0) {
      console.log("‚ùå No brain cells in the lab! Create a brain cell first.");
      return;
    }

    console.log("Available brain cells:");
    brainCells.forEach((cell, index) => {
      console.log(
        `${index + 1}. Cell ${cell.getId()} - Knowledge: ${cell
          .getKnowledge()
          .join(", ")}`
      );
    });

    const choice = readline.question(
      `\nChoose brain cell (1-${brainCells.length}): `
    );
    const index = parseInt(choice) - 1;

    if (index >= 0 && index < brainCells.length) {
      const brainCell = brainCells[index];
      const knowledge = readline.question("What would you like to teach? ");

      if (knowledge.trim()) {
        brainCell.learn(knowledge);
        console.log(`‚úÖ Brain cell learned: "${knowledge}"`);
      } else {
        console.log("‚ùå Please enter some knowledge to teach!");
      }
    } else {
      console.log("‚ùå Invalid brain cell number!");
    }
  }

  private giveOxygenToBloodCell(): void {
    console.log("\nü©∏ GIVE OXYGEN TO BLOOD CELL");
    console.log("============================");

    const bloodCells = this.cells.filter(
      (c) => c instanceof BloodCell
    ) as BloodCell[];

    if (bloodCells.length === 0) {
      console.log("‚ùå No blood cells in the lab! Create a blood cell first.");
      return;
    }

    console.log("Available blood cells:");
    bloodCells.forEach((cell, index) => {
      console.log(
        `${index + 1}. Cell ${cell.getId()} - O2 Level: ${cell.oxygenLevel}/100`
      );
    });

    const choice = readline.question(
      `\nChoose blood cell (1-${bloodCells.length}): `
    );
    const index = parseInt(choice) - 1;

    if (index >= 0 && index < bloodCells.length) {
      const bloodCell = bloodCells[index];
      const amount = readline.question("How much oxygen to give (1-50)? ");
      const oxygenAmount = parseInt(amount);

      if (oxygenAmount > 0 && oxygenAmount <= 50) {
        bloodCell.carryOxygen(oxygenAmount);
        console.log(
          `‚úÖ Blood cell now carrying ${bloodCell.oxygenLevel}/100 oxygen!`
        );
      } else {
        console.log("‚ùå Please enter a valid amount (1-50)!");
      }
    } else {
      console.log("‚ùå Invalid blood cell number!");
    }
  }

  private managePrototypes(): void {
    console.log("\nüè≠ PROTOTYPE MANAGEMENT");
    console.log("======================");

    const prototypes = this.factory.listPrototypes();
    console.log("Current prototypes:");
    prototypes.forEach((type, index) => {
      console.log(`${index + 1}. ${type}`);
    });

    console.log("\nOptions:");
    console.log("1. Add custom prototype");
    console.log("2. View prototype details");
    console.log("3. Go back");

    const choice = readline.question("\nChoose option (1-3): ");

    switch (choice) {
      case "1":
        this.addCustomPrototype();
        break;
      case "2":
        this.viewPrototypeDetails();
        break;
      case "3":
        break;
      default:
        console.log("‚ùå Invalid choice!");
    }
  }

  private addCustomPrototype(): void {
    console.log("\n‚ûï ADD CUSTOM PROTOTYPE");
    console.log("======================");

    const name = readline.question("Enter prototype name: ");
    const dna = readline.question("Enter DNA sequence: ");

    console.log("Choose cell type:");
    console.log("1. Basic Cell");
    console.log("2. Blood Cell");
    console.log("3. Brain Cell");

    const typeChoice = readline.question("Enter choice (1-3): ");

    try {
      let newCell: Cell;

      switch (typeChoice) {
        case "1":
          newCell = new Cell(dna);
          break;
        case "2":
          const oxygen = parseInt(
            readline.question("Initial oxygen level (0-100): ") || "0"
          );
          newCell = new BloodCell(dna, oxygen);
          break;
        case "3":
          const knowledge = readline.question(
            "Initial knowledge (comma-separated): "
          );
          const knowledgeArray = knowledge
            ? knowledge.split(",").map((k) => k.trim())
            : [];
          newCell = new BrainCell(dna, knowledgeArray);
          break;
        default:
          console.log("‚ùå Invalid cell type!");
          return;
      }

      this.factory.addPrototype(name, newCell);
      console.log(`‚úÖ Added prototype "${name}" successfully!`);
    } catch (error) {
      console.log(`‚ùå Failed to add prototype: ${error}`);
    }
  }

  private viewPrototypeDetails(): void {
    const prototypes = this.factory.listPrototypes();
    const choice = readline.question(
      `\nChoose prototype to view (1-${prototypes.length}): `
    );
    const index = parseInt(choice) - 1;

    if (index >= 0 && index < prototypes.length) {
      const prototypeName = prototypes[index];
      console.log(`\nüìã Prototype: ${prototypeName}`);
      console.log("Details: This is a template cell ready for cloning");
    } else {
      console.log("‚ùå Invalid prototype number!");
    }
  }

  private showCellList(): void {
    console.log("Cells in lab:");
    this.cells.forEach((cell, index) => {
      let type = "Basic";
      if (cell instanceof BloodCell) type = "Blood";
      if (cell instanceof BrainCell) type = "Brain";
      console.log(`${index + 1}. [${type}] ${cell.getInfo()}`);
    });
  }

  private exitLab(): void {
    console.log("\nüéØ Lab Session Complete!");
    console.log("========================");
    console.log(`Final Results:`);
    console.log(`- Total cells created: ${this.cells.length}`);
    console.log(`- Prototype pattern demonstrated: ‚úÖ`);
    console.log(`- Cells learned to divide themselves: ‚úÖ`);
    console.log("\nThanks for exploring the Prototype Design Pattern! üß¨");
    this.running = false;
  }
}
